const Order=require("../../models/Order").Order,path=require("path"),mkdirp=require("mkdirp"),fs=require("fs"),parse=require("../../helpers/parseList").parse,validate=require("../../helpers/validation").validate;function decodeBase64Image(e){var r=e.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),d={};return 3!==r.length?new Error("Invalid input string"):(d.type=r[1],d.data=new Buffer(r[2],"base64"),d)}module.exports={index:function(e,r){e.query.sort="updatedAt";let d=e.user.isAdmin?{}:{userId:e.user.id},a=parse("orders",e,r,["uuid"],d,!0);r.json({total:a.total,rows:Order.format(a.chain)})},show:function(e,r){r.json(Order.getReations(e.query.id))},update:function(e,r){if(e.body.base64Data){let r=decodeBase64Image(e.body.base64Data),d=path.join(__dirname,"../../../public/upload/orders");fs.existsSync(d)||mkdirp(d);let a=path.join(d,e.body.id+".png");fs.writeFile(a,r.data,"base64",function(e){console.log(e)}),e.body.src=path.join("/upload/orders",e.body.id+".png"),delete e.body.base64Data}let d=Order.update(e.body);r.json({status:!0,result:d})},create:function(e,r){e.body.file=e.file,e.body.userId=e.user.id,validate(Order,{name:e.body.name},e,r)},delete:function(e,r){Order.delete(e.body),r.json({status:!0,msg:"删除成功！"})},download:function(e,r){let d=Order.findBy({id:e.params.id}),a=path.join(__dirname,"../../../public/",d.src);r.download(a)}};