const Order=require("../../models/Order").Order,path=require("path"),mkdirp=require("mkdirp"),fs=require("fs"),parse=require("../../helpers/parseList").parse,validate=require("../../helpers/validation").validate;function decodeBase64Image(e){var r=e.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),a={};return 3!==r.length?new Error("Invalid input string"):(a.type=r[1],a.data=new Buffer(r[2],"base64"),a)}module.exports={index:function(e,r){let a=e.user.isAdmin?{}:{userId:e.user.id},d=parse("orders",e,r,["uuid"],a,!0);r.json({total:d.total,rows:d.chain.value()})},show:function(e,r){r.json(Order.getReations(e.query.id))},update:function(e,r){if(e.body.base64Data){let r=decodeBase64Image(e.body.base64Data),a=path.join(__dirname,"../../../public/upload/orders");fs.existsSync(a)||mkdirp(a);let d=path.join(a,e.body.id+".png");fs.writeFile(d,r.data,"base64",function(e){console.log(e)}),e.body.src=path.join("/upload/orders",e.body.id+".png"),delete e.body.base64Data}let a=Order.update(e.body);r.json({status:!0,result:a})},create:function(e,r){e.body.file=e.file,e.body.userId=e.user.id,e.body.company=e.user.company,validate(Order,{name:e.body.name},e,r)},delete:function(e,r){Order.delete(e.body),r.json({status:!0,msg:"删除成功！"})},download:function(e,r){let a=Order.findBy({id:e.params.id}),d=path.join(__dirname,"../../../public/",a.src);r.download(d)}};