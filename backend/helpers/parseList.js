const utils=require("./utils"),url=require("url"),pluralize=require("pluralize"),path=require("path"),Model=require("../models/_Base").Model;function getFullURL(e){return""+url.format({protocol:e.protocol,host:e.get("host")})+e.originalUrl}function formatDate(e,t){t=t||"-";var r=function(e){var t="0"+e;return t.substr(t.length-2)},a=new Date(e);return a.getFullYear()+t+r(a.getMonth()+1)+t+r(a.getDate())}module.exports={parse:function(e,t,r,a,n,u){let l=require("lodash"),i=Model.db(e),o=i.size(),s=t.query.search,c=t.query.offset,p=t.query.end,f=t.query.page,d=t.query.sort,g=t.query.order||t.query.direction,q=t.query.limit;if(delete t.query.search,delete t.query.offset,delete t.query.end,delete t.query.page,delete t.query.order,delete t.query.limit,Object.keys(t.query).forEach(function(e){var r=i.value();for(var a in r)if(l.has(r[a],e)||"callback"===e||"_"===e||/_lte$/.test(e)||/_gte$/.test(e)||/_ne$/.test(e)||/_like$/.test(e))return;delete t.query[e]}),s&&(i=i.filter(function(e){for(var t in a)if(e[a[t]]===s)return!0})),n&&(i=i.filter(function(e){let t=!0;for(var r in n)t=t&&e[r]==n[r];return t})),Object.keys(t.query).forEach(function(e){var r;"callback"!==e&&"_"!==e&&(r=[].concat(t.query[e]),i=i.filter(function(t){return r.map(function(r){var a=/_ne$/.test(e),n=/_lte$/.test(e)||/_gte$/.test(e),u=/_like$/.test(e),i=e.replace(/(_lte|_gte|_ne|_like)$/,""),o=l.get(t,i);if(void 0!==o)return n?/_gte$/.test(e)?r<=o:r>=o:a?r!==o.toString():u?new RegExp(r,"i").test(o.toString()):r===o.toString()}).reduce(function(e,t){return e||t})}))}),d&&(g=g||"ASC",i=i.sortBy(function(e){return l.get(e,d)}),g.match(/DESC/i)&&(i=i.reverse())),(p||q||f)&&(r.setHeader("X-Total-Count",i.size()),o=i.size(),r.setHeader("Access-Control-Expose-Headers","X-Total-Count"+(f?", Link":""))),f){f=(f=parseInt(f,10))>=1?f:1,q=parseInt(q,10)||10;var y=utils.getPage(i.value(),f,q),h={},v=getFullURL(t);y.first&&(h.first=v.replace("page="+y.current,"page="+y.first)),y.prev&&(h.prev=v.replace("page="+y.current,"page="+y.prev)),y.next&&(h.next=v.replace("page="+y.current,"page="+y.next)),y.last&&(h.last=v.replace("page="+y.current,"page="+y.last)),r.links(h),i=l.chain(y.items)}else p?(c=parseInt(c,10)||0,p=parseInt(p,10),i=i.slice(c,p)):q&&(c=parseInt(c,10)||0,q=parseInt(q,10),i=i.slice(c,c+q));if(i=i.map(function(e){return e.publishedDate&&(e.publishedDate=formatDate(e.publishedDate)),e.updatedAt&&(e.updatedAt=formatDate(e.updatedAt)),e.createdAt&&(e.createdAt=formatDate(e.createdAt)),e}),u)return{total:o,chain:i};r.json({total:o,rows:i.value()})}};