"use strict";var url=require("url"),express=require("express"),_=require("lodash"),pluralize=require("pluralize"),utils=require("../utils");module.exports=function(e,t){var r=express.Router();function a(r,a){a&&[].concat(a).forEach(function(a){if(e.get(a).value){var u={};u[pluralize.singular(t)+"Id"]=r.id,r[a]=e.get(a).filter(u).value()}})}function u(t,r){r&&[].concat(r).forEach(function(r){var a=pluralize(r);if(e.get(a).value()){var u=r+"Id";t[r]=e.get(a).getById(t[u]).value()}})}function n(r,a,u){var n=r.params.id,l=e.get(t),o=(l="PATCH"===r.method?l.updateById(n,r.body):l.replaceById(n,r.body)).value();o&&(a.locals.data=o),u()}return console.log(t),r.route("/").get(function(r,n,l){var o=e.get(t),i=r.query.q,s=r.query._start,c=r.query._end,d=r.query._page,p=r.query._sort,f=r.query._order,g=r.query._limit,v=r.query._embed,y=r.query._expand;if(delete r.query.q,delete r.query._start,delete r.query._end,delete r.query._sort,delete r.query._order,delete r.query._limit,delete r.query._embed,delete r.query._expand,Object.keys(r.query).forEach(function(a){var u=e.get(t).value();for(var n in u)if(_.has(u[n],a)||"callback"===a||"_"===a||/_lte$/.test(a)||/_gte$/.test(a)||/_ne$/.test(a)||/_like$/.test(a))return;delete r.query[a]}),i&&(i=i.toLowerCase(),o=o.filter(function(t){for(var r in t){var a=t[r];if(e._.deepQuery(a,i))return!0}})),Object.keys(r.query).forEach(function(e){var t;"callback"!==e&&"_"!==e&&(t=[].concat(r.query[e]),o=o.filter(function(r){return t.map(function(t){var a=/_ne$/.test(e),u=/_lte$/.test(e)||/_gte$/.test(e),n=/_like$/.test(e),l=e.replace(/(_lte|_gte|_ne|_like)$/,""),o=_.get(r,l);if(void 0!==o)return u?/_gte$/.test(e)?t<=o:t>=o:a?t!==o.toString():n?new RegExp(t,"i").test(o.toString()):t===o.toString()}).reduce(function(e,t){return e||t})}))}),p&&(f=f||"ASC",o=o.sortBy(function(e){return _.get(e,p)}),"DESC"===f&&(o=o.reverse())),(c||g||d)&&(n.setHeader("X-Total-Count",o.size()),n.setHeader("Access-Control-Expose-Headers","X-Total-Count"+(d?", Link":""))),d){d=(d=parseInt(d,10))>=1?d:1,g=parseInt(g,10)||10;var q=utils.getPage(o.value(),d,g),m={},I=function(e){return""+url.format({protocol:e.protocol,host:e.get("host")})+e.originalUrl}(r);q.first&&(m.first=I.replace("page="+q.current,"page="+q.first)),q.prev&&(m.prev=I.replace("page="+q.current,"page="+q.prev)),q.next&&(m.next=I.replace("page="+q.current,"page="+q.next)),q.last&&(m.last=I.replace("page="+q.current,"page="+q.last)),n.links(m),o=_.chain(q.items)}else c?(s=parseInt(s,10)||0,c=parseInt(c,10),o=o.slice(s,c)):g&&(s=parseInt(s,10)||0,g=parseInt(g,10),o=o.slice(s,s+g));o=o.cloneDeep().forEach(function(e){a(e,v),u(e,y)}),n.locals.data=o.value(),l()}).post(function(r,a,u){var n=e.get(t).insert(r.body).value();a.status(201),a.locals.data=n,u()}),r.route("/:id").get(function(r,n,l){var o=r.query._embed,i=r.query._expand,s=e.get(t).getById(r.params.id).value();if(s){var c=_.cloneDeep(s);a(c,o),u(c,i),n.locals.data=c}l()}).put(n).patch(n).delete(function(r,a,u){var n=e.get(t).removeById(r.params.id).value();e._.getRemovable(e.getState()).forEach(function(t){e.get(t.name).removeById(t.id).value()}),n&&(a.locals.data={}),u()}),r};