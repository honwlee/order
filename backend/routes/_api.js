"use strict";const ctrls=require("../controllers/api/controllers"),path=require("path"),Model=require("../models/_Base").Model,fs=require("fs"),dbpath=path.join(__dirname,"../dbs"),jsonServer=require("../lib/restsrv/"),plural=require("../lib/restsrv/router/plural"),nested=require("../lib/restsrv/router/nested"),dbms=require("../lib/dbms/"),jsondb=dbms(dbpath,{master_file_name:"master.json"}),mkdirp=require("mkdirp"),_=require("lodash"),User=require("../models/User").User,multer=require("multer");module.exports=function(e,t,r,s){fs.existsSync(s)||mkdirp(s),_(Object.keys(ctrls)).each(function(t){let i=ctrls[t];console.log(t),_(["update","create","show","delete","index","config","select","public"]).each(function(o){if(i.module[o]){if(o.match(/^(update|create|delete)/)){let n=multer.diskStorage({destination:function(e,t,r){let o=path.join(s,"upload",i.uploadPath||"");fs.existsSync(o)||mkdirp.sync(o),r(null,o)},filename:function(e,t,r){r(null,Date.now()+"-"+t.originalname)}}),l=multer({storage:n});console.log("POST: /api/"+t+"/"+o),e.post("/api/"+t+"/"+o,r,l.single("file"),function(e,t){i.module[o](e,t)})}else console.log("GET: /api/"+t+"/"+o),e.get("/api/"+t+"/"+o,r,function(e,t){i.module[o](e,t)})}})}),e.get("/api/orders/:id/download",r,function(e,t){require("../controllers/api/OrdersController").download(e,t)}),e.get("/api/system/check",function(e,t){var r=User.delay(!0,!0);t.json({checked:r.delayed,status:!0,msg:r.msg,id:r.id,title:r.title})}),e.post("/api/system/update",function(e,t){User.update({id:e.body.id,username:"delay",title:e.body.title,msg:e.body.msg,isActive:"true"});t.json({status:!0})}),e.get("/api/admin/check",r,function(e,t){t.json(e.user)}),e.get("/api/home/index",r,function(e,t){require("../controllers/api/HomeController").index(e,t)}),e.get("/api/auth/check",function(e,t){e.isAuthenticated()?t.json({status:!0,auth:!0}):t.json({status:!1,auth:!0})})};