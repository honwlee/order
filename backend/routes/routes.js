const passport=require("passport"),path=require("path"),api=require("./_api");let redirectUserAfterLogin=function(e,r){var s=e.validatedUser,t=e.session.referer||e.query.referrer||"/admin";if(delete e.session.referer,e.ajax)e.error?r.status(400).json(e.error):r.status(200).json({referrer:t||"",user:s});else{if(e.error)return r.redirect("back");t.match(/signin|signup|password|logout/)&&(t="/admin"),r.redirect(t)}},captureRefererForLogin=function(e,r,s){e.session.user?delete e.session.referer:e.session.referer=e.session.referer||e.query.referer||e.get("referer")||e.url,s()};module.exports=function(e,r,s,t){api(e,r,s,t),e.post("/registry",passport.authenticate("local-signup",{successRedirect:"/active",failureRedirect:"/signup",failureFlash:!0})),e.get("/reset_password",passport.authenticate("local-signup"),function(e,r){let s=e.user;s&&(console.log("REGISTERED: "+s.username),r.json({status:!0,msg:"Successful created new user."})),s||(console.log("COULD NOT REGISTER"),r.json({status:!1,msg:"That username is already in use, please try a different one."}))}),e.post("/login",passport.authenticate("local-signin",{successRedirect:"/active",failureRedirect:"/signin"})),e.get("/signin",captureRefererForLogin,function(e,r,s){r.render("signin",{layout:null})}),e.get("/",captureRefererForLogin,function(e,r,s){r.render("signin",{layout:null})}),e.get("/active",function(e,r,s){e.user&&e.user.isActive?r.redirect("/admin"):r.render("active",{layout:null})}),e.get("/signup",captureRefererForLogin,function(e,r,s){r.render("signup",{layout:null,message:e.flash("signupMessage")})}),e.get("/password/reset",s,function(e,r,s){r.render("password",{layout:null,isSuperAdmin:e.user.isSuperAdmin,userId:e.user.id})}),e.get("/logout",function(e,r){e.logout(),r.redirect("/"),e.session.notice="You have successfully been logged out!"}),e.get("/api/auth/check",function(e,r){e.isAuthenticated()?r.json({status:!0,auth:!0}):r.json({status:!1,auth:!0})}),e.get("/logout",function(e,r){e.logout(),r.redirect("/"),e.session.notice="You have successfully been logged out!"}),e.use(function(e,r,s){s()})};